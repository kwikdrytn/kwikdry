

# Plan: Precise Zip Code Boundaries for Service Zones

## Overview

Currently, service zone boundaries are generated by creating a convex hull around zip code bounding boxes from Mapbox geocoding. This produces rough, approximate polygons. To display precise zip code boundaries, we will switch to the **US Census Bureau's ZCTA (Zip Code Tabulation Area) boundaries** via the Census Reporter API.

## Current State

- Service zones in HouseCall Pro are defined by lists of zip codes
- The sync function currently uses Mapbox geocoding to get approximate bounding boxes for each zip code
- These bounding boxes are merged into a single convex hull polygon per zone
- Result: Large, imprecise boundaries that don't follow actual zip code shapes

## Proposed Solution

Use the **Census Reporter API** which provides precise ZCTA polygon boundaries from US Census TIGER data.

### API Details

- **Endpoint**: `https://api.censusreporter.org/1.0/geo/tiger2023/86000US{zipcode}?geom=true`
- **Format**: Returns GeoJSON Feature with detailed polygon/multipolygon coordinates
- **Free**: No API key required
- **Coverage**: All US zip codes

---

## Technical Implementation

### 1. Update Edge Function: `supabase/functions/sync-hcp-data/index.ts`

**Replace** the current `fetchZipCodeBounds` and `buildZonePolygonFromZipCodes` functions with new logic:

```text
New Functions to Add:
+-----------------------------------------------------+
| fetchZipCodePolygon(zipCode: string)                |
|   - Calls Census Reporter API with tiger2023        |
|   - Returns GeoJSON geometry for single zip code    |
|   - Handles MultiPolygon to Polygon conversion      |
+-----------------------------------------------------+
| mergePolygons(polygons: GeoJSON[])                  |
|   - Collects all coordinates from multiple zips     |
|   - Creates a MultiPolygon containing each zip area |
|   - Alternative: Union using turf.js or convex hull |
+-----------------------------------------------------+
| buildZonePolygonFromZipCodes(zipCodes: string[])    |
|   - Fetches each zip's precise boundary             |
|   - Merges into single MultiPolygon for the zone    |
|   - Limits concurrent requests (rate limiting)      |
+-----------------------------------------------------+
```

**Key Changes:**

1. Add Census Reporter API endpoint constant
2. Create `fetchZipCodePolygon` function to retrieve precise boundaries
3. Merge multiple zip code polygons into a GeoJSON `MultiPolygon` (preserves each zip's shape)
4. Handle API errors gracefully with fallback to current Mapbox bounding box approach
5. Add rate limiting (sequential requests with small delays) to avoid overwhelming the API

### 2. Update Database Records

The `hcp_service_zones.polygon_geojson` column already supports storing GeoJSON. The new MultiPolygon format will render correctly on the map since Mapbox GL JS supports both Polygon and MultiPolygon types.

### 3. Map Rendering (No Changes Required)

The `JobMapView.tsx` component already handles GeoJSON polygons from `polygon_geojson`. MultiPolygon geometries will render each zip code area as part of the zone.

---

## Technical Details

### Sample API Response (Truncated)

```json
{
  "type": "Feature",
  "geometry": {
    "type": "MultiPolygon",
    "coordinates": [[[[-84.038, 35.896], [-84.037, 35.897], ...]]]
  },
  "properties": {
    "display_name": "37919",
    "population": 30956
  }
}
```

### Edge Function Changes

```typescript
const CENSUS_API_BASE = 'https://api.censusreporter.org/1.0/geo/tiger2023';

async function fetchZipCodePolygon(zipCode: string): Promise<object | null> {
  const url = `${CENSUS_API_BASE}/86000US${zipCode}?geom=true`;
  const response = await fetch(url);
  if (!response.ok) return null;
  const data = await response.json();
  return data?.geometry || null;
}

async function buildZonePolygonFromZipCodes(
  zipCodes: string[]
): Promise<object | null> {
  const polygons: object[] = [];
  
  for (const zip of zipCodes.slice(0, 25)) {
    const geometry = await fetchZipCodePolygon(zip.trim());
    if (geometry) polygons.push(geometry);
    // Small delay to be respectful of the API
    await new Promise(r => setTimeout(r, 100));
  }
  
  if (polygons.length === 0) return null;
  
  // Merge all polygons into a single MultiPolygon
  const allCoordinates: number[][][][] = [];
  for (const geom of polygons) {
    if (geom.type === 'Polygon') {
      allCoordinates.push(geom.coordinates);
    } else if (geom.type === 'MultiPolygon') {
      allCoordinates.push(...geom.coordinates);
    }
  }
  
  return {
    type: 'MultiPolygon',
    coordinates: allCoordinates
  };
}
```

---

## Implementation Steps

1. **Update `sync-hcp-data/index.ts`**
   - Add Census Reporter API constant
   - Replace `fetchZipCodeBounds` with `fetchZipCodePolygon`
   - Update `buildZonePolygonFromZipCodes` to merge precise polygons
   - Keep Mapbox fallback for cases where Census API fails

2. **Deploy the updated edge function**

3. **Re-sync HCP data** to populate zones with precise boundaries

---

## Expected Result

After syncing:
- Each service zone will display the **exact shape** of its constituent zip codes
- Boundaries will follow actual ZCTA borders (roads, rivers, municipal lines)
- Multiple disconnected zip codes will render as separate filled areas within the same zone
- Zone colors and labels will continue to work as before

---

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Census API rate limits | Add 100ms delay between requests; limit to 25 zips per zone |
| API unavailable | Fallback to current Mapbox bounding box approach |
| Large polygon data | MultiPolygon format is standard GeoJSON; Mapbox handles it efficiently |
| Invalid zip codes | Skip and log; continue with valid zips |

